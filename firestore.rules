/**
 * @fileoverview Firestore Security Rules for the collaborative vocabulary learning app.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for personal data under `/users/{userId}` and uses a visibility-based model for sessions.
 *
 * Data Structure:
 * - `/users/{userId}`: Stores user profiles, accessible only to the owning user.
 * - `/users/{userId}/personalVocabulary/{vocabularyId}`: Stores personal vocabulary cards, accessible only to the owning user.
 * - `/sessions/{sessionId}`: Stores session data, with read access based on the `visibility` field (public or private) and write access restricted to the host.
 * - `/sessions/{sessionId}/vocabularyCards/{vocabularyCardId}`: Stores vocabulary cards associated with a session; create, update and delete are restricted to the owning user.
 *
 * Key Security Decisions:
 * - Users can only read and write their own data under their respective `/users/{userId}` path.
 * - Listing users is disallowed to prevent enumeration.
 * - Sessions are either publicly readable or restricted to the host for writes.
 *
 * Denormalization for Authorization:
 * The `hostId` field is present in the `/sessions/{sessionId}` document to allow for efficient ownership checks on session writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) - If the user's auth UID matches the userId in the path.
     * @allow (get, list) - If the user's auth UID matches the userId in the path.
     * @allow (update, delete) - If the user's auth UID matches the userId in the path and the document exists.
     * @deny (create) - If the user's auth UID does not match the userId in the path.
     * @deny (get, list) - If the user's auth UID does not match the userId in the path.
     * @deny (update, delete) - If the user's auth UID does not match the userId in the path or the document does not exist.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // prevent user enumeration

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id; // enforce immutability of userId
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to a user's personal vocabulary cards.
     * @path /users/{userId}/personalVocabulary/{personalVocabularyId}
     * @allow (create) - If the user's auth UID matches the userId in the path.
     * @allow (get, list) - If the user's auth UID matches the userId in the path.
     * @allow (update, delete) - If the user's auth UID matches the userId in the path and the document exists.
     * @deny (create) - If the user's auth UID does not match the userId in the path.
     * @deny (get, list) - If the user's auth UID does not match the userId in the path.
     * @deny (update, delete) - If the user's auth UID does not match the userId in the path or the document does not exist.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/personalVocabulary/{personalVocabularyId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId; // enforce immutability of userId
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to session data. Public sessions are readable by anyone, but only the host can modify them.
     * @path /sessions/{sessionId}
     * @allow (get, list) - If true (publicly readable).
     * @allow (create) - If the user's auth UID matches the hostId in the request.
     * @allow (update, delete) - If the user's auth UID matches the hostId in the document and the document exists.
     * @deny (create) - If the user's auth UID does not match the hostId in the request.
     * @deny (update, delete) - If the user's auth UID does not match the hostId in the document or the document does not exist.
     * @principle Allows public reads but restricts writes to the session host.
     */
    match /sessions/{sessionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isHost(hostId) {
        return isSignedIn() && request.auth.uid == hostId;
      }

      function isExistingHost(hostId) {
        return isHost(hostId) && resource != null;
      }

      allow get, list: if true;

      allow create: if isHost(request.resource.data.hostId);
      allow update: if isExistingHost(resource.data.hostId);
      allow delete: if isExistingHost(resource.data.hostId);
    }

    /**
     * @description Controls access to vocabulary cards within a session.  Only the creator can modify a vocabulary card.
     * @path /sessions/{sessionId}/vocabularyCards/{vocabularyCardId}
     * @allow (get, list) - If true (publicly readable within a session).
     * @allow (create) - If the user's auth UID matches the creatorId in the request.
     * @allow (update, delete) - If the user's auth UID matches the creatorId in the document and the document exists.
     * @deny (create) - If the user's auth UID does not match the creatorId in the request.
     * @deny (update, delete) - If the user's auth UID does not match the creatorId in the document or the document does not exist.
     * @principle Allows public reads within a session but restricts writes to the card creator.
     */
    match /sessions/{sessionId}/vocabularyCards/{vocabularyCardId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isCreator(creatorId) {
        return isSignedIn() && request.auth.uid == creatorId;
      }

      function isExistingCreator(creatorId) {
        return isCreator(creatorId) && resource != null;
      }

      allow get, list: if true;

      allow create: if isCreator(request.resource.data.creatorId);
      allow update: if isExistingCreator(resource.data.creatorId);
      allow delete: if isExistingCreator(resource.data.creatorId);
    }
  }
}