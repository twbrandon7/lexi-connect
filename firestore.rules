/**
 * @file Firestore Security Rules
 * @core_philosophy This ruleset enforces a user-ownership model for user profiles and personal vocabulary,
 *  and a mixed-access model for sessions and vocabulary cards within sessions.
 *  User data is stored under /users/{userId}, ensuring that only the authenticated user can access their own profile and personal vocabulary.
 *  Sessions are stored under /sessions/{sessionId}, with access controlled by the 'visibility' field (public or private) and the 'hostId' field (session creator).
 *  Vocabulary cards are stored under /sessions/{sessionId}/vocabularyCards/{vocabularyCardId}, with access restricted to session participants and the card creator.
 * @data_structure
 *  /users/{userId} (User profile)
 *  /users/{userId}/personalVocabulary/{personalVocabularyId} (Personal vocabulary cards)
 *  /sessions/{sessionId} (Sessions)
 *  /sessions/{sessionId}/vocabularyCards/{vocabularyCardId} (Vocabulary cards within sessions)
 * @key_security_decisions
 *  - Users can only access their own profile data.
 *  - Users can only manage their own personal vocabulary.
 *  - Public sessions are readable by anyone.
 *  - Private sessions are accessible only to the host and authorized participants (not yet implemented).
 *  - Vocabulary cards can be created by any user in a session.
 *  - Only the creator can update or delete a vocabulary card.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own profile data.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @deny (create) User with ID 'user456' cannot create a profile with ID 'user123'.
     * @allow (get) User with ID 'user123' can retrieve their own profile.
     * @deny (get) User with ID 'user456' cannot retrieve the profile with ID 'user123'.
     * @allow (update) User with ID 'user123' can update their own profile.
     * @deny (update) User with ID 'user456' cannot update the profile with ID 'user123'.
     * @allow (delete) User with ID 'user123' can delete their own profile.
     * @deny (delete) User with ID 'user456' cannot delete the profile with ID 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage their own personal vocabulary.
     * @path /users/{userId}/personalVocabulary/{personalVocabularyId}
     * @allow (create) User with ID 'user123' can create a personal vocabulary card under their profile.
     * @deny (create) User with ID 'user456' cannot create a personal vocabulary card under user123's profile.
     * @allow (get) User with ID 'user123' can retrieve a personal vocabulary card from their profile.
     * @deny (get) User with ID 'user456' cannot retrieve a personal vocabulary card from user123's profile.
     * @allow (update) User with ID 'user123' can update a personal vocabulary card from their profile.
     * @deny (update) User with ID 'user456' cannot update a personal vocabulary card from user123's profile.
     * @allow (delete) User with ID 'user123' can delete a personal vocabulary card from their profile.
     * @deny (delete) User with ID 'user456' cannot delete a personal vocabulary card from user123's profile.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/personalVocabulary/{personalVocabularyId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows anyone to read public sessions, but restricts modification to the session host.
     * @path /sessions/{sessionId}
     * @allow (create) User with ID 'user123' can create a new session.
     * @deny (create) User with ID 'user123' cannot create a session with an 'hostId' that doesn't match their UID.
     * @allow (get) Anyone can retrieve a session.
     * @allow (list) Anyone can list sessions.
     * @deny (update) User with ID 'user456' cannot update a session they don't host.
     * @deny (delete) User with ID 'user456' cannot delete a session they don't host.
     * @principle Controls session access based on ownership and visibility.
     */
    match /sessions/{sessionId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.hostId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.hostId == request.auth.uid;
    }

    /**
     * @description Allows users to create vocabulary cards within a session. Restricts updates and deletes to the card creator.
     * @path /sessions/{sessionId}/vocabularyCards/{vocabularyCardId}
     * @allow (create) User with ID 'user123' can create a vocabulary card in session 'session456'.
     * @deny (create) User with ID 'user123' cannot create a vocabulary card in session 'session456' with a 'sessionId' that does not match.
     * @allow (get) Anyone can retrieve a vocabulary card from any session.
     * @allow (list) Anyone can list vocabulary cards from any session.
     * @deny (update) User with ID 'user456' cannot update a vocabulary card they didn't create.
     * @deny (delete) User with ID 'user456' cannot delete a vocabulary card they didn't create.
     * @principle Enforces creator-based control for vocabulary card modification.
     */
    match /sessions/{sessionId}/vocabularyCards/{vocabularyCardId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.creatorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.creatorId == request.auth.uid;
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId));
    }
  }
}