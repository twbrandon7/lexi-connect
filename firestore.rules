/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and personal vocabulary,
 *              while providing a flexible access control mechanism for collaborative learning sessions
 *              based on the session's visibility and host.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Only the authenticated user can access their own profile.
 * - /users/{userId}/personalVocabulary/{personalVocabularyId}: Stores user's personal vocabulary. Only the user can manage their own vocabulary.
 * - /sessions/{sessionId}: Stores all sessions (public and private). Access is controlled by the 'visibility' field and the 'hostId'.
 * - /sessions/{sessionId}/vocabularyCards/{vocabularyCardId}: Stores vocabulary cards within a session.
 *   Access is controlled by session visibility and host.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profiles and personal vocabulary.
 * - Sessions can be public or private, affecting who can read and write vocabulary cards.
 * - The 'hostId' field in the session document determines who has administrative privileges for the session.
 *
 * Denormalization for Authorization:
 * - The 'visibility' field in the session document is used to determine read access for public sessions.
 * - The 'hostId' field in the session document determines who has administrative privileges for the session.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces that only the authenticated user can access their own profile.
     * @path /users/{userId}
     * @allow (read, write) if the request is made by the user with matching userId.
     * @deny (read, write) if the request is made by a different user.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource.data.id == userId;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces that only the authenticated user can manage their own personal vocabulary.
     * @path /users/{userId}/personalVocabulary/{personalVocabularyId}
     * @allow (read, write) if the request is made by the user with matching userId.
     * @deny (read, write) if the request is made by a different user.
     * @principle Restricts access to a user's own personal vocabulary.
     */
    match /users/{userId}/personalVocabulary/{personalVocabularyId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource.data.userId == userId;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Controls access to sessions based on visibility and host.
     * @path /sessions/{sessionId}
     * @allow (get, list) if the session is public.
     * @allow (create) if the user is authenticated.
     * @allow (update, delete) if the user is the host of the session.
     * @principle Manages access to collaborative learning sessions based on visibility and ownership.
     */
    match /sessions/{sessionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isHost(hostId) {
        return request.auth != null && request.auth.uid == hostId;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isHost(resource.data.hostId) && resource != null;
      allow delete: if isHost(resource.data.hostId) && resource != null;
    }

    /**
     * @description Controls access to vocabulary cards within a session.
     * @path /sessions/{sessionId}/vocabularyCards/{vocabularyCardId}
     * @allow (read) if the session is public.
     * @allow (create) if the user is authenticated.
     * @allow (update, delete) if the user is the host of the session.
     * @principle Manages access to vocabulary cards based on session visibility and ownership.
     */
    match /sessions/{sessionId}/vocabularyCards/{vocabularyCardId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isHost(hostId) {
        return request.auth != null && request.auth.uid == hostId;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isHost(get(/databases/$(database)/documents/sessions/$(sessionId)).data.hostId) && resource != null;
      allow delete: if isHost(get(/databases/$(database)/documents/sessions/$(sessionId)).data.hostId) && resource != null;
    }
  }
}